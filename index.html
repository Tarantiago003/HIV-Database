<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HIV Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>

  <style>
    body { font-family: Arial; padding: 20px; background: #f4f6f8; }
    input, select, button { padding: 6px; margin: 4px; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <div id="root"></div>

<script type="text/babel">

const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1BFe5A0RjmegcN7-Mn2HgYiV8HoHj7YEpHV9vOI0TQDZRFKTmHLOg5KL2rQ5eMgvSkQ/exec";

function App() {
  const [patients, setPatients] = React.useState([]);
  const [filteredPatients, setFilteredPatients] = React.useState([]);
  const [searchTerm, setSearchTerm] = React.useState("");
  const [filterSex, setFilterSex] = React.useState("");
  const [filterStatus, setFilterStatus] = React.useState("");

  const [form, setForm] = React.useState({
    name: "", code: "", age: "", sex: "",
    birthday: "", address: "", dateScreened: "",
    confirmatoryDate: "", treatmentHub: "", status: ""
  });

  const [editId, setEditId] = React.useState(null);

  /* ---------- LOAD DATA ---------- */
  React.useEffect(() => {
    fetch(`${SCRIPT_URL}?action=read`)
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          setPatients(data.data);
          setFilteredPatients(data.data);
        }
      });
  }, []);

  /* ---------- FILTER (FIXED) ---------- */
  React.useEffect(() => {
    let filtered = [...patients];

    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filtered = filtered.filter(p =>
        ['name', 'code', 'address', 'sex', 'status']
          .some(k => (p[k] || "").toLowerCase().includes(term))
      );
    }

    if (filterSex) filtered = filtered.filter(p => p.sex === filterSex);
    if (filterStatus) filtered = filtered.filter(p => p.status === filterStatus);

    setFilteredPatients(filtered);
  }, [searchTerm, filterSex, filterStatus, patients]);

  /* ---------- INPUT HANDLER ---------- */
  function handleChange(e) {
    setForm({ ...form, [e.target.name]: e.target.value });
  }

  /* ---------- CREATE / UPDATE ---------- */
  function handleSubmit(e) {
    e.preventDefault();

    const action = editId ? "update" : "create";
    const payload = editId
      ? { action, id: editId, data: form }
      : { action, data: form };

    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(() => window.location.reload());
  }

  /* ---------- EDIT ---------- */
  function handleEdit(p) {
    setForm(p);
    setEditId(p.id);
  }

  /* ---------- DELETE ---------- */
  function handleDelete(id) {
    if (!confirm("Delete this record?")) return;

    fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action: "delete", id })
    })
    .then(res => res.json())
    .then(() => window.location.reload());
  }

  return (
    <div>
      <h2>HIV Database</h2>

      {/* FORM */}
      <form onSubmit={handleSubmit}>
        {Object.keys(form).map(key => (
          <input
            key={key}
            name={key}
            placeholder={key}
            value={form[key]}
            onChange={handleChange}
          />
        ))}
        <button type="submit">{editId ? "Update" : "Add"}</button>
      </form>

      {/* FILTERS */}
      <div>
        <input placeholder="Search" value={searchTerm}
               onChange={e => setSearchTerm(e.target.value)} />
        <select onChange={e => setFilterSex(e.target.value)}>
          <option value="">All Sex</option>
          <option>Male</option>
          <option>Female</option>
        </select>
        <select onChange={e => setFilterStatus(e.target.value)}>
          <option value="">All Status</option>
          <option>Positive</option>
          <option>Negative</option>
        </select>
      </div>

      {/* TABLE */}
      <table>
        <thead>
          <tr>
            <th>Name</th><th>Code</th><th>Age</th><th>Sex</th>
            <th>Status</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {filteredPatients.map(p => (
            <tr key={p.id}>
              <td>{p.name}</td>
              <td>{p.code}</td>
              <td>{p.age}</td>
              <td>{p.sex}</td>
              <td>{p.status}</td>
              <td>
                <button onClick={() => handleEdit(p)}>Edit</button>
                <button onClick={() => handleDelete(p.id)}>Delete</button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>
</body>
</html>
